<!DOCTYPE html>
<html lang="pt-br">
<head>
<title>Câmeras COR Rio</title>
<meta charset="UTF-8">
<meta name="robots" content="noindex">
<meta name="viewport" content="width=device-width, initial-scale=1">

	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

</head>
<body>

<div id="map" style="height: 100vh;"></div>

	<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
	<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
var map = L.map('map').setView([-22.9332614,-43.4324536], 10);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '<a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

var markers = L.markerClusterGroup();

function createMarker(lat, lng, description, id) {
    // Padroniza o ID para seis dígitos
    var standardizedId = id.toString().padStart(6, '0');

    var marker = L.marker([lat, lng]).bindPopup("<div style='width:300px'><p style='color:#000000;text-align:center'>ID: " + id + "<br>" + description + "<br><video id='popup-video-" + id + "' controls autoplay width='100%'><source src='https://app.tixxi.rio/api/v1/xcor/video/" + standardizedId + "-2023' type='video/mp4'></video><br><a href='http://aplicativo.cocr.com.br/camera/" + id + "' target='_blank'>Ver em tamanho maior</a></p><div>");
    markers.addLayer(marker);
	
marker.on('popupopen', function () {
    var popupVideo = document.getElementById('popup-video-' + id);

    // Define um ouvinte de evento para reiniciar o vídeo após o término
    popupVideo.addEventListener('ended', function () {
        // Atualiza a URL do vídeo para forçar o navegador a carregar uma nova versão
        popupVideo.src = 'https://app.tixxi.rio/api/v1/xcor/video/' + standardizedId + '-2023?' + new Date().getTime();
        popupVideo.play(); // Inicia a reprodução novamente
    });

    var playButton = document.getElementById('popup-video-play-button');
    
    playButton.addEventListener('click', function () {
        // Atualiza a URL do vídeo e inicia a reprodução
        popupVideo.src = 'https://app.tixxi.rio/api/v1/xcor/video/' + standardizedId + '-2023?' + new Date().getTime();
        popupVideo.play();
    });
});
    
    marker.on('popupclose', function () {
        // Pausa o vídeo quando o pop-up é fechado
        var popupVideo = document.getElementById('popup-video-' + id);
        popupVideo.pause();
        popupVideo.src = '';
    });
}

fetch('https://aplicativo.cocr.com.br/cameras_api')
    .then(response => response.text())
    .then(data => {
        var linhas = data.split("\n");
        for (var i = 0; i < linhas.length; i++) {
            var campos = linhas[i].split(";");
            if (campos.length >= 4) {
                var lat = parseFloat(campos[0]);
                var lng = parseFloat(campos[1]);
                var description = campos[2];
                var id = campos[3].trim();
                createMarker(lat, lng, description, id);
            }
        }
        map.addLayer(markers);
    })
    .catch(error => console.error('Erro ao obter os dados:', error));
</script>

</body>
</html>
