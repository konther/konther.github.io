<!DOCTYPE html>
<html lang="pt-br">
<head>
<title>Câmeras COR Rio</title>
<meta charset="UTF-8">
<meta name="robots" content="noindex">
<meta name="viewport" content="width=device-width, initial-scale=1">

	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

</head>
<body>

<div id="map" style="height: 100vh;"></div>

	<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" ></script>
	<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
	<script src="https://unpkg.com/leaflet-image"></script>

<script>

// Inicializar o mapa e definir a posição e o nível de zoom inicial
var map = L.map('map').setView([-22.9332614,-43.4324536], 10);

// Adicionar uma camada de base ao mapa (neste exemplo, usando o OpenStreetMap)
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '<a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

var markers = L.markerClusterGroup();

function createMarker(lat, lng, description, id) {
    var marker = L.marker([lat, lng]).bindPopup("<div style='width:300px'><p style='color:#000000'>ID: " + id + "<br>" + description + "<br><img id='popup-image-" + id + "' src='http://187.111.99.18:9004/?CODE=" + id + "' width='100%'><br><a href='http://aplicativo.cocr.com.br/camera/" + id + "' target='_blank'>Ver em tamanho maior</a></p><div>");
    markers.addLayer(marker);
	
            marker.on('popupopen', function () {
				// Carrega a imagem apenas quando o pop-up é aberto
				var popupImage = document.getElementById('popup-image-' + id);
				popupImage.src = "http://187.111.99.18:9004/?CODE=" + id ;
				});
				
			marker.on('popupclose', function () {
				// Substitui a imagem por uma imagem estática quando o pop-up é fechado
				var popupImage = document.getElementById('popup-image-' + id);
				popupImage.src = 'none.jpg';
            });
}

        fetch('https://aplicativo.cocr.com.br/cameras_api')
            .then(response => response.text())
            .then(data => {
                // Quebrar os dados em linhas
                var linhas = data.split("\n");
				
                for (var i = 0; i < linhas.length; i++) {
                    var campos = linhas[i].split(";");
                    if (campos.length >= 4) { // Verificar se a quantidade de campos é suficiente					
                    var lat = parseFloat(campos[0]);
                    var lng = parseFloat(campos[1]);
                    var description = campos[2];
                    var id = campos[3].trim();					
                    createMarker(lat, lng, description, id);
					}
                }				


// Adicionar o grupo de marcadores ao mapa
map.addLayer(markers);

            })
            .catch(error => console.error('Erro ao obter os dados:', error));
    </script>

</body>
</html>